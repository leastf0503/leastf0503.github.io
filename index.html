<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VitalCore - Ihr Gesundheitsportal</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pulse-slow { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        @keyframes blink {
          0%, 88%, 100% { transform: scaleY(1); }
          92% { transform: scaleY(0.05); }
        }

        .animate-blink-1 {
          animation: blink 2.5s infinite;
          transform-origin: center;
        }

        .animate-blink-2 {
          animation: blink 2.5s infinite;
          animation-delay: 0.4s;
          transform-origin: center;
        }

        .animate-slide-up { animation: slide-up 0.5s ease-out forwards; }
        .animate-fade-in { animation: fade-in 0.8s ease-out forwards; }
        .animate-pulse-slow { animation: pulse-slow 3s infinite; }
        .animate-spin-slow { animation: spin 3s linear infinite; }
        
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        #error-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; padding: 20px; background: #fee2e2; border-bottom: 2px solid #ef4444; color: #991b1b; z-index: 9999; font-family: monospace; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <div id="error-overlay">
        <strong>Systemfehler:</strong> <span id="error-msg">Unbekannter Fehler</span>
    </div>
    <script>
        window.onerror = function(msg, url, line, col, error) {
            document.getElementById('error-overlay').style.display = 'block';
            document.getElementById('error-msg').innerText = msg + " (Zeile: " + line + ")";
            return false;
        };
    </script>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // 1. KONFIGURATION
        const MIN_BROWSING_TIME_1 = 5; 
        const MIN_REGISTRATION_TIME = 20; 
        const MIN_BROWSING_TIME_2 = 40; 
        const COOKIE_BANNER_DELAY_MS = 3000; 
        const SOSCI_BASE_URL = "https://www.soscisurvey.de/BA25LeaPaula/";

        // 2. ICONS & ASSETS
        const Icon = ({ path, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
        );

        const RealisticEye = ({ color, className, hasLashes }) => {
            const gradId = React.useId().replace(/:/g, ""); 
            return (
                <svg viewBox="0 0 100 70" className={className} preserveAspectRatio="xMidYMid meet" style={{ overflow: 'visible' }}>
                    <defs>
                        <radialGradient id={`whiteGrad-${gradId}`} cx="50%" cy="50%" r="50%" fx="50%" fy="30%">
                            <stop offset="0%" stopColor="#ffffff" />
                            <stop offset="80%" stopColor="#ffffff" />
                            <stop offset="100%" stopColor="#d1d5db" />
                        </radialGradient>
                        <radialGradient id={`irisGrad-${gradId}`}>
                            <stop offset="20%" stopColor="#111" />
                            <stop offset="40%" stopColor={color} />
                            <stop offset="100%" stopColor="#000" stopOpacity="0.8" />
                        </radialGradient>
                    </defs>
                    <g className="animate-blink-1">
                        {hasLashes && (
                            <g stroke="#1a1a1a" strokeWidth="1.2" fill="none" strokeLinecap="round" opacity="0.8">
                                <path d="M15,28 Q10,15 5,12" /><path d="M25,23 Q20,10 15,8" /><path d="M35,20 Q32,8 28,5" />
                                <path d="M50,18 Q50,8 50,4" /><path d="M65,20 Q68,8 72,5" /><path d="M75,23 Q80,10 85,8" /><path d="M85,28 Q90,15 95,12" />
                            </g>
                        )}
                        <path d="M5,35 Q50,-12 95,35 Q50,82 5,35 Z" fill={`url(#whiteGrad-${gradId})`} stroke="#4b5563" strokeWidth="0.5" />
                        <circle cx="50" cy="35" r="17" fill={`url(#irisGrad-${gradId})`} />
                        {[...Array(12)].map((_, i) => (
                            <line key={i} x1="50" y1="35" x2={50 + 15 * Math.cos(i * 30 * Math.PI/180)} y2={35 + 15 * Math.sin(i * 30 * Math.PI/180)} stroke="rgba(255,255,255,0.1)" strokeWidth="0.5" />
                        ))}
                        <circle cx="50" cy="35" r="8" fill="#000" />
                        <circle cx="45" cy="30" r="3.5" fill="#fff" opacity="0.8" />
                        <circle cx="56" cy="40" r="1.5" fill="#fff" opacity="0.4" />
                    </g>
                </svg>
            );
        };

        const paths = {
            shield: <React.Fragment><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="M12 8v4"/><path d="M12 16h.01"/></React.Fragment>,
            check: <React.Fragment><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></React.Fragment>,
            user: <React.Fragment><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></React.Fragment>,
            search: <React.Fragment><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></React.Fragment>,
            arrowRight: <path d="M5 12h14m-7-7 7 7-7 7"/>,
            arrowLeft: <path d="M19 12H5m7 7-7-7 7-7"/>,
            leaf: <path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10Z" />,
            clock: <circle cx="12" cy="12" r="10"/>,
            activity: <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>,
            apple: <React.Fragment><path d="M12 20.94c1.5 0 2.75 1.06 4 1.06 3 0 6-8 6-12.22A4.91 4.91 0 0 0 17 5c-2.22 0-4 1.44-5 2-1-.56-2.78-2-5-2a4.9 4.9 0 0 0-5 4.78C2 14 5 22 8 22c1.25 0 2.5-1.06 4-1.06Z"/><path d="M10 2c1 .5 2 2 2 5"/></React.Fragment>,
            coffee: <React.Fragment><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" x2="6" y1="2" y2="4"/><line x1="10" x2="10" y1="2" y2="4"/><line x1="14" x2="14" y1="2" y2="4"/></React.Fragment>,
            heart: <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>,
            heartFilled: <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" fill="currentColor" stroke="none"/>,
            star: <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />,
            ciagrette: <React.Fragment><path d="M18 8c0-2.5-2-2.5-2-5"/><path d="M22 8c0-2.5-2-2.5-2-5"/><rect x="2" y="13" width="20" height="6" rx="2"/><path d="M22 16h-4"/><path d="M2 16h4"/></React.Fragment>,
        };

        // 3. DATEN
        const BLOG_CONTENT = [
            { 
                id: 1, title: "Die 5 S√§ulen Ihrer Langlebigkeit", cat: "Forschung", time: "12 min", date: "Aktuell", author: "Dr. med. Weber", 
                image: "https://images.unsplash.com/photo-1476480862126-209bfaa8edc8?auto=format&fit=crop&w=800&q=80", 
                desc: "Erfahren Sie, wie kleine Anpassungen in Ihrer t√§glichen Routine Ihr biologisches Alter messbar senken k√∂nnen.", 
                fullText: [
                    "Die moderne Altersforschung hat in den letzten Jahren bahnbrechende Erkenntnisse geliefert: Ihr biologisches Alter ist kein feststehender Wert, sondern das Resultat Ihrer t√§glichen Entscheidungen. W√§hrend die Genetik lediglich die 'geladene Waffe' darstellt, ist es Ihr Lebensstil, der letztlich den Abzug dr√ºckt. Wir sprechen hier von Epigenetik ‚Äì der F√§higkeit, durch √§u√üere Einfl√ºsse zu bestimmen, welche Gene in Ihrem K√∂rper aktiv geschaltet werden und welche stumm bleiben.",
                    "Die erste S√§ule bildet die Ern√§hrung. Es geht hierbei weniger um strikten Verzicht oder kurzfristige Di√§ten, sondern um die Qualit√§t der molekularen Information, die Sie Ihren Zellen zuf√ºhren. Komplexe Kohlenhydrate und hochwertige Omega-3-Fetts√§uren sch√ºtzen Ihre Zellmembranen vor oxidativem Stress und verhindern die sogenannte Glykation ‚Äì die Verzuckerung von Gewebestrukturen. Zudem aktivieren Phyto-N√§hrstoffe wie Resveratrol bestimmte Langlebigkeits-Gene, die Sirtuine, welche Reparaturprozesse an der DNA einleiten.",
                    "Zweitens spielt die moderate Bewegung eine entscheidende Rolle f√ºr die vaskul√§re Integrit√§t. Sie m√ºssen kein Leistungssportler sein, um Ihre Gef√§√üe elastisch zu halten. Schon 30 Minuten z√ºgiges Gehen t√§glich l√∂sen die Aussch√ºttung von Stickstoffmonoxid aus, was die Gef√§√üw√§nde entspannt und den Blutdruck senkt. Auf zellul√§rer Ebene aktiviert diese Belastung Ihre Mitochondrien ‚Äì die Kraftwerke Ihrer Zellen. Durch den Prozess der Mitophagie werden besch√§digte Mitochondrien aussortiert und durch neue, leistungsstarke Einheiten ersetzt, was Ihr Energieniveau nachhaltig steigert.",
                    "Die dritte S√§ule ist die Schlafhygiene, ein oft untersch√§tzter Faktor der Regeneration. W√§hrend Sie schlafen, wird das sogenannte glympathische System aktiv ‚Äì eine Art Selbstreinigung des Gehirns, bei der toxische Stoffwechselprodukte wie Beta-Amyloide abtransportiert werden. Ohne diese n√§chtliche Drainage steigen die Entz√ºndungswerte im gesamten System massiv an. Chronischer Schlafmangel korreliert direkt mit einer Verk√ºrzung der Telomere, den Schutzkappen unserer Chromosomen, was den Alterungsprozess auf DNA-Ebene drastisch beschleunigt.",
                    "Viertens: Stressmanagement und hormonelle Balance. Chronisch hohes Cortisol ist ein regelrechter Zellgift-Cocktail. Es schw√§cht das Immunsystem, baut Muskulatur ab und f√∂rdert die Einlagerung von viszeralem Fett. Wir zeigen Ihnen Techniken, wie Sie Ihren Vagusnerv ‚Äì den Hauptnerv unseres parasympathischen Nervensystems ‚Äì gezielt stimulieren k√∂nnen.",
                    "F√ºnftens: Soziale Resonanz und psychische Koh√§renz. Der Mensch ist ein biologisch auf Kooperation programmiertes Wesen. Statistiken aus den sogenannten 'Blue Zones' belegen, dass Menschen in stabilen sozialen Gef√ºgen deutlich seltener an chronischen Krankheiten leiden. Einsamkeit hingegen l√∂st im K√∂rper √§hnliche Stressreaktionen aus wie physischer Schmerz.",
                    "Zusammenfassend l√§sst sich sagen: Langlebigkeit ist kein Zufallsprodukt, sondern die Summe Ihrer t√§glichen Gewohnheiten. Jeder Schritt, jede Mahlzeit und jede Stunde Schlaf ist eine Investition in Ihr zuk√ºnftiges Ich."
                ] 
            },
            { 
                id: 2, title: "Intervallfasten 16:8 f√ºr Einsteiger", cat: "Ern√§hrung", time: "10 min", date: "10. Okt", author: "Sarah Klein", 
                image: "https://images.unsplash.com/photo-1498837167922-ddd27525d352?auto=format&fit=crop&w=800", 
                desc: "Warum zeitlich begrenzte Esspausen f√ºr Ihren Stoffwechsel wertvoller sind als jede klassische Kalorien-Di√§t.", 
                fullText: [
                    "Haben Sie sich schon einmal gefragt, warum Ihr K√∂rper st√§ndig Hunger signalisiert? In unserer modernen Gesellschaft ist Ihr Verdauungssystem permanent im Einsatz.",
                    "Das Intervallfasten, insbesondere die 16:8 Methode, setzt genau hier an. Indem Sie 16 Stunden fasten und in einem 8-Stunden-Fenster essen, geben Sie Ihrem K√∂rper die Chance auf Autophagie.",
                    "Autophagie ist ein k√∂rpereigener Prozess, bei dem besch√§digte Zellstrukturen abgebaut und recycelt werden. Das sch√ºtzt Sie vor neurodegenerativen Erkrankungen und st√§rkt Ihre Stoffwechselrate.",
                    "Wichtig f√ºr Sie: In der Fastenphase ist nur Wasser, unges√º√üter Tee oder schwarzer Kaffee erlaubt. Jede Kalorienzufuhr w√ºrde den Insulinspiegel heben und den Regenerationsprozess sofort stoppen.",
                    "Starten Sie langsam: Schieben Sie Ihr Fr√ºhst√ºck jeden Tag eine Stunde weiter nach hinten, bis Sie das 16-Stunden-Fenster bequem erreichen."
                ] 
            },
            { 
                id: 3, title: "Digital Detox & Ihr Cortisolspiegel", cat: "Mental Health", time: "15 min", date: "08. Okt", author: "M. Psych. Bauer", 
                image: "https://images.unsplash.com/photo-1544716278-ca5e3f4abd8c?auto=format&fit=crop&w=800&q=80", 
                desc: "Wie die st√§ndige Erreichbarkeit Ihr Gehirn in einen Alarmzustand versetzt und was Sie dagegen tun k√∂nnen.", 
                fullText: [
                    "Ihr Smartphone ist heute Ihr st√§ndiger Begleiter, doch der Preis f√ºr diese Vernetzung ist hoch. Jede Push-Benachrichtigung l√∂st in Ihrem Gehirn einen kleinen Dopamin-Sto√ü aus, gefolgt von einem Anstieg des Stresshormons Cortisol.",
                    "Chronisch erh√∂hte Cortisolwerte beeintr√§chtigen Ihre Konzentrationsf√§higkeit und f√ºhren langfristig zu Schlafst√∂rungen und Ersch√∂pfungszust√§nden.",
                    "Digital Detox bedeutet nicht, dass Sie Ihre Technik aufgeben m√ºssen. Es geht um einen bewussten Umgang. Reservieren Sie sich Zeitfenster, in denen Sie offline sind.",
                    "Indem Sie Ihr Schlafzimmer zur handyfreien Zone erkl√§ren, erlauben Sie Ihrem Nervensystem, wirklich zur Ruhe zu kommen. Sie werden bemerken, wie sich Ihre Schlafqualit√§t bereits nach wenigen Tagen verbessert."
                ] 
            },
            { 
                id: 4, title: "Herzgesundheit: Vorsorge neu gedacht", cat: "Pr√§vention", time: "11 min", date: "05. Okt", author: "Prof. Dr. Lang", 
                image: "https://images.unsplash.com/photo-1505751172876-fa1923c5c528?auto=format&fit=crop&w=800", 
                desc: "Kennen Sie Ihre Blutwerte? Warum moderne Diagnostik weit √ºber einfaches Cholesterin hinausgeht.", 
                fullText: [
                    "Herz-Kreislauf-Erkrankungen sind nach wie vor die h√§ufigste Todesursache, doch viele Risiken lie√üen sich durch pr√§zise Vorsorge minimieren.",
                    "Moderne klinische Marker wie das Lipoprotein(a) oder das hochsensitive CRP geben uns heute Einblicke in Ihr individuelles Risiko, die fr√ºher unm√∂glich waren.",
                    "Ein besonderes Augenmerk liegt auf stillen Entz√ºndungen in Ihren Gef√§√üw√§nden. Diese werden durch Fehlern√§hrung, Bewegungsmangel, aber auch durch unbehandelten Stress beg√ºnstigt.",
                    "Wir empfehlen Ihnen, einmal j√§hrlich ein erweitertes Blutbild anfertigen zu lassen. Wer seine Zahlen kennt, kann gezielt gegensteuern, bevor Symptome auftreten."
                ] 
            },
            { 
                id: 5, title: "Toxikologische Belastung durch Rauchen", cat: "Pr√§vention", time: "9 min", author: "Dr. Lisa Neubauer", 
                image: "https://cdn.prod.www.spiegel.de/images/caa850d5-0001-0004-0000-000001220757_w1200_r1_fpx41.97_fpy50.jpg", 
                desc: "Warum auch gelegentlicher Konsum Ihre DNA sch√§digt und wie Ihr K√∂rper regenerieren kann.", 
                fullText: [
                    "Tabakkonsum ist die gr√∂√üte vermeidbare Gesundheitsgefahr unserer Zeit. Jede Zigarette f√ºhrt Ihrem K√∂rper √ºber 4.000 Chemikalien zu, von denen viele direkt Ihre DNA angreifen.",
                    "Die gute Nachricht f√ºr Sie: Ihr K√∂rper besitzt enorme Selbstheilungskr√§fte. Schon 24 Stunden nach der letzten Zigarette sinkt Ihr Risiko f√ºr einen Herzinfarkt deutlich.",
                    "Nach einem Jahr ohne Tabak hat sich Ihr Risiko f√ºr koronare Herzkrankheiten bereits halbiert. Es ist nie zu sp√§t, diesen Regenerationsprozess einzuleiten."
                ] 
            },
            { 
                id: 6, title: "Finanzieller Stress & K√∂rperliche Resilienz", cat: "Mental Health", time: "14 min", author: "Dr. Wagner", 
                image: "https://images.unsplash.com/photo-1554224155-1696413565d3?auto=format&fit=crop&w=800", 
                desc: "Wie √∂konomische Sorgen Ihre Gesundheit beeinflussen und wie Sie Ihre psychische Widerstandskraft st√§rken.", 
                fullText: [
                    "Es ist klinisch erwiesen: Finanzielle Sorgen und Schuldenlast wirken wie ein permanenter Stressor auf Ihr vegetatives Nervensystem. Ihr K√∂rper befindet sich in einer dauerhaften 'Flucht-oder-Kampf'-Reaktion.",
                    "Um Ihre Resilienz zu st√§rken, ist es wichtig, diese Zusammenh√§nge zu erkennen. Gesundheit ist ein ganzheitliches Konzept, das auch Ihre sozio-√∂konomische Stabilit√§t umfasst.",
                    "Suchen Sie aktiv nach Wegen, diesen Stress zu reduzieren ‚Äì sei es durch professionelle Beratung oder gezielte Entspannungstechniken."
                ] 
            }
        ];

        const PERSONALIZED_CONTENT = [
            { 
                id: 101, title: "Ihr individuelles Stoffwechsel-Profil", cat: "Analyse", time: "Jetzt", author: "VitalCore AI", match: "99% Match",
                image: "https://images.unsplash.com/photo-1576091160399-112ba8d25d1d?auto=format&fit=crop&w=800", 
                fullText: [
                    "Anhand der von Ihnen √ºbermittelten biometrischen Daten (Alter, Gr√∂√üe und Gewicht) hat unser Algorithmus Ihren pr√§zisen basalen Ruheumsatz (BMR) kalkuliert. Dieser Wert repr√§sentiert die exakte Energiemenge, die Ihr Organismus ben√∂tigt, um lebenswichtige Funktionen wie Thermoregulation, Zellreparatur und kardiovaskul√§re Aktivit√§t im absoluten Ruhezustand aufrechtzuerhalten.",
                    "Ihre Angaben zur aktuellen Ern√§hrungsform wurden in Echtzeit mit Ihrem gemeldeten Aktivit√§tslevel korreliert. Das Ergebnis unserer Analyse bescheinigt Ihnen eine 'moderate metabolische Flexibilit√§t'. Das bedeutet, dass Ihr K√∂rper in der Lage ist, effizient zwischen der Verbrennung von Kohlenhydraten und Fetts√§uren zu wechseln.",
                    "Wir stellen fest, dass Ihr K√∂rper aktuell eine erh√∂hte Unterst√ºtzung bei der Stickstoffbilanz ben√∂tigt. Wir empfehlen Ihnen daher dringend, die Zufuhr von hochwertigen Proteinen leicht zu erh√∂hen. Dies ist essenziell, um die Proteinsynthese zu stimuliieren und Ihre Muskelmasse proaktiv zu sch√ºtzen.",
                    "Alle detaillierten Handlungsanweisungen finden Sie ab sofort in Ihrem pers√∂nlichen Download-Bereich."
                ] 
            },
            { 
                id: 102, title: "Ihre biometrische Lebensplanung & Prognose", cat: "Zukunfts-Report", time: "14 min", author: "Prof. Dr. Leisner", match: "84% Match",
                image: "https://images.unsplash.com/photo-1559757175-5700dde675bc?auto=format&fit=crop&w=800", 
                fullText: [
                    "Dieser umfassende Zukunfts-Report basiert auf einer biostatistischen Modellierung, die Ihre biometrischen Basisdaten mit Ihren pers√∂nlichen Angaben zur langfristigen Lebensplanung und Ihrem sozio-√∂konomischen Status verkn√ºpft.",
                    "Ein zentraler Punkt Ihrer Analyse ist der angegebene Reproduktionswunsch. Die VitalCore-Engine gleicht diesen Wunsch mit Ihrem aktuellen biologischen Zeitfenster, Ihrem sportlichen Aktivit√§tslevel und Ihrem BMI ab. Auf Basis dieser Daten ermitteln wir eine statistische Wahrscheinlichkeit f√ºr eine komplikationslose Umsetzung Ihrer Familienplanung.",
                    "Zus√§tzlich haben wir Ihren Versicherungsstatus (GKV/PKV) als entscheidenden Faktor f√ºr Ihre medizinische Versorgungskette in die Prognose einbezogen. Dies definiert den Zugang zu modernsten diagnostischen Verfahren.",
                    "Wir empfehlen Ihnen dringend, dieses Profil als strategische Grundlage f√ºr zuk√ºnftige Beratungsgespr√§che mit Fach√§rzten zu nutzen."
                ] 
            },
            { 
                id: 103, title: "Wirtschaftsstatus & Gesundheitsrisiko", cat: "Sozio-Analyse", time: "Jetzt", author: "VitalCore Finance", match: "93% Match",
                image: "https://images.unsplash.com/photo-1450101499163-c8848c66ca85?auto=format&fit=crop&w=800", 
                fullText: [
                    "Die bereitgestellten Informationen zu Ihrem Einkommen sowie Ihrer Schuldensituation bilden eine essenzielle S√§ule unserer Risikoanalyse. Unser System nutzt diese Daten, um Ihre sogenannte 'allostatische Last' zu berechnen ‚Äì also den kumulativen Verschlei√ü von K√∂rper und Geist durch Stress.",
                    "Der VitalCore Finance-Algorithmus hat auf Basis Ihrer Angaben einen individuellen 'Economic Stress Index' (ESI) erstellt. Ein hohes Ma√ü an finanzieller Unsicherheit korreliert in Ihrem spezifischen Profil mit einem signifikant erh√∂hten Risiko f√ºr psychosomatische Sekund√§rbeschwerden.",
                    "Ziel dieser Analyse ist es, Ihre medizinische Versorgung optimal mit Ihren finanziellen M√∂glichkeiten zu harmonisieren. In Ihrem pers√∂nlichen Bericht finden Sie eine Priorisierung von Ma√ünahmen, die den h√∂chsten gesundheitlichen Nutzen bieten."
                ] 
            },
            { 
                id: 104, title: "K√∂rperbild & Optimierungsw√ºnsche", cat: "Psychosomatik", time: "Jetzt", author: "Dr. Stein", match: "95% Match",
                image: "https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=800", 
                fullText: [
                    "In Ihrem Profil haben Sie spezifische Aspekte Ihres K√∂rpers definiert, die Sie gerne durch operative Eingriffe oder therapeutische Interventionen optimieren m√∂chten. Unsere Engine hat diese W√ºnsche in Korrelation zu Ihrem aktuellen Zufriedenheitswert gesetzt.",
                    "Dabei analysieren wir die sogenannte 'Body-Mind-Gap' ‚Äì also die Diskrepanz zwischen Ihrer objektiven biometrischen Verfassung und Ihrer subjektiven K√∂rperwahrnehmung. Ziel ist es, festzustellen, ob die Ver√§nderungen eine signifikante Verbesserung Ihrer Lebensqualit√§t bewirken k√∂nnen.",
                    "Da die psychische Resilienz einen entscheidenden Faktor f√ºr den Heilungsprozess darstellt, empfehlen wir vor jeder invasiven Intervention ein fundiertes kl√§rendes Gespr√§ch mit einem Experten.",
                    "Wir haben in Ihrem Dossier eine Checkliste f√ºr solche Beratungsgespr√§che vorbereitet."
                ] 
            }
        ];

        // 4. HELFER FUNKTIONEN
        const getGroupConfig = (groupID) => {
            const map = {
                1: { eyes: false, sound: false, info: false },
                2: { eyes: true,  sound: false, info: false },
                3: { eyes: false, sound: true,  info: false },
                4: { eyes: true,  sound: true,  info: false },
                5: { eyes: true,  sound: false, info: true  },
                6: { eyes: false, sound: true,  info: true  },
                7: { eyes: true,  sound: true,  info: true  }
            };
            return map[groupID] || map[1]; 
        };

        const playSoundFile = (audioObj) => {
            if (!audioObj) return;
            audioObj.currentTime = 0;
            const playPromise = audioObj.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => console.log("Audio Error:", error));
            }
        };

        // 5. KOMPONENTEN
        const IntroScreen = ({ onStart }) => (
            <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
                <div className="bg-white max-w-md w-full p-8 rounded-2xl shadow-2xl text-center animate-fade-in">
                    <div className="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6">
                        <Icon path={paths.activity} className="w-8 h-8" />
                    </div>
                    <h1 className="text-2xl font-bold text-gray-900 mb-4">Willkommen</h1>
                    <p className="text-gray-600 mb-8">
                        Wichtig: Bitte stellen Sie sicher, dass Ihr Ton eingeschaltet ist!üîä<br/>
                        Klicken Sie erst dann auf "Starten", um die Webseite zu laden.
                    </p>
                    <div className="text-xs text-gray-300 mt-2 mb-6">
                        System-Check: {window.location.search.includes('t=') ? "‚úÖ Token erkannt" : "‚ùå Kein Token gefunden"}
                    </div>
                    <button onClick={onStart} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition-transform transform active:scale-95 text-lg">
                        Starten
                    </button>
                </div>
            </div>
        );

        const AudioTest = ({ onPassed, audioFile }) => {
    const [played, setPlayed] = useState(false);
    const [selected, setSelected] = useState(null);
    const [error, setError] = useState(false);
    const [success, setSuccess] = useState(false); // Neuer Status f√ºr Erfolg
    const audioRef = useRef(null); // Speicher f√ºr das Audio-Objekt

    const options = [
        { id: 'dog', label: 'Hundebellen' },
        { id: 'bell', label: 'Glocke' },
        { id: 'rain', label: 'Regenschauer' },
        { id: 'car', label: 'Autohupe' }
    ];

    const handlePlay = () => {
        // Falls schon ein Ton l√§uft, stoppen wir ihn erst (verhindert Echo)
        if (audioRef.current) {
            audioRef.current.pause();
            audioRef.current.currentTime = 0;
        }
        audioRef.current = new Audio(audioFile);
        audioRef.current.play().catch(e => console.error("Audio Playback failed", e));
        setPlayed(true);
    };

    const checkResult = (id) => {
        if (success) return; // Verhindert Mehrfachklicks bei Erfolg

        setSelected(id);
        if (id === 'bell') {
            // 1. TON SOFORT STOPPEN
            if (audioRef.current) {
                audioRef.current.pause();
                audioRef.current.currentTime = 0;
            }
            
            // 2. ERFOLGSMELDUNG ANZEIGEN
            setSuccess(true);
            
            // 3. VERZ√ñGERUNG (2 Sek.), dann weiter zum Blog
            setTimeout(() => {
                onPassed(); 
            }, 2000);

        } else {
            setError(true);
            setTimeout(() => { setError(false); setSelected(null); }, 2000);
        }
    };

    return (
        <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
            <div className="bg-white max-w-md w-full p-10 rounded-[40px] shadow-2xl text-center animate-fade-in">
                
                {/* Dynamischer Titel */}
                <h2 className={`text-2xl font-black mb-6 uppercase tracking-tight transition-colors ${success ? 'text-green-600' : 'text-slate-900'}`}>
                    {success ? '‚úì Korrekt!' : 'Audio-Check'}
                </h2>

                {!success ? (
                    <>
                        <p className="text-slate-600 mb-8 text-sm leading-relaxed">
                            Um fortzufahren, m√ºssen wir sicherstellen, dass Ihr Ton funktioniert. 
                            Klicken Sie auf den Button und w√§hlen Sie aus, was Sie h√∂ren.
                        </p>

                        <button 
                            onClick={handlePlay}
                            className={`w-full py-4 mb-8 rounded-2xl font-bold flex items-center justify-center gap-2 transition-all ${played ? 'bg-slate-100 text-slate-400' : 'bg-blue-600 text-white shadow-lg active:scale-95'}`}
                        >
                            <Icon path={paths.activity} className="w-5 h-5" />
                            {played ? "Ton wird/wurde abgespielt" : "Ton abspielen"}
                        </button>

                        {played && (
                            <div className="grid grid-cols-1 gap-3 animate-fade-in">
                                {options.map(opt => (
                                    <button
                                        key={opt.id}
                                        onClick={() => checkResult(opt.id)}
                                        className={`py-3 rounded-xl border-2 font-bold transition-all ${
                                            selected === opt.id 
                                                ? (opt.id === 'bell' ? 'border-green-500 bg-green-50 text-green-700' : 'border-red-500 bg-red-50 text-red-700')
                                                : 'border-slate-100 hover:border-blue-200 text-slate-600'
                                        }`}
                                    >
                                        {opt.label}
                                    </button>
                                ))}
                            </div>
                        )}
                    </>
                ) : (
                    /* ERFOLGS-ANSICHT */
                    <div className="py-10 animate-fade-in">
                        <div className="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6">
                            <Icon path={paths.check} className="w-10 h-10" />
                        </div>
                        <p className="text-green-700 font-bold text-lg">Audiotest bestanden!</p>
                        <p className="text-slate-400 text-xs mt-2">Die Webseite wird geladen...</p>
                    </div>
                )}
                
                {error && <p className="text-red-500 text-xs mt-4 font-bold animate-pulse">Das war nicht richtig. Bitte versuchen Sie es erneut.</p>}
            </div>
        </div>
    );
};
        const StimulusOverlay = ({ config, variant = "banner" }) => {
    if (!config || !config.eyes) return null;
    const eyeColor = variant === 'banner' ? '#3b82f6' : '#5D4037';
    const positionClass = variant === 'form' ? 'fixed top-4 left-1/2 -translate-x-1/2' : 'absolute -top-12 left-1/2 -translate-x-1/2'; 

    return (
        <div className={`pointer-events-none z-[100] flex flex-col items-center gap-2 ${positionClass}`}>
            <div className="flex gap-4 items-center justify-center bg-white p-2 rounded-full shadow-[0_0_30px_rgba(255,255,255,1),0_10px_30px_rgba(0,0,0,0.2)] border border-slate-100">
                <RealisticEye color={eyeColor} className="w-20 h-14 animate-pulse-slow" hasLashes={true} />
                <RealisticEye color={eyeColor} className="w-20 h-14 animate-pulse-slow" hasLashes={true} />
            </div>
        </div>
    );
};

        const CookieBanner = ({ group, onDecision, audioObject, onBannerLoad }) => {
    const config = getGroupConfig(group);
    useEffect(() => { 
        onBannerLoad(); 
        if (config.sound && audioObject) playSoundFile(audioObject); 
    }, []);
    
    const [details, setDetails] = useState(false);

    return (
        <div className="fixed bottom-0 left-0 right-0 z-50 p-4 md:p-8 bg-white shadow-[0_-20px_50px_rgba(0,0,0,0.15)] border-t-4 border-blue-600 animate-slide-up rounded-t-[40px]">
            <div className="max-w-7xl mx-auto relative pt-8">
                
                {/* 1. SCHWEBENDER TEIL: Augen und Info-Box sauber NEBENEINANDER */}
<div className="absolute -top-40 left-1/2 -translate-x-1/2 flex items-center justify-center gap-8 w-full max-w-6xl pointer-events-none">
    
    {/* Die Augen: Wir erzwingen hier 'relative', damit sie nicht in die Mitte springen */}
    <div className="shrink-0 pointer-events-auto relative !left-0 !translate-x-0">
        <StimulusOverlay config={config} variant="banner" />
    </div>

    {/* Die Info-Box */}
    <div className={`pointer-events-auto max-w-md p-6 rounded-[30px] shadow-2xl border-2 animate-fade-in ${config.info ? 'bg-red-50/95 border-red-200' : 'bg-blue-50/95 border-blue-200'}`}>
        <div className={`flex items-center gap-2 font-black mb-2 uppercase tracking-tighter text-[10px] ${config.info ? 'text-red-600' : 'text-blue-600'}`}>
            <Icon path={config.info ? paths.shield : paths.activity} className="w-4 h-4"/> 
            {config.info ? 'HINWEIS ZUR DATENERFASSUNG' : 'WILLKOMMEN BEI VITALCORE'}
        </div>
        <p className={`text-[10px] leading-relaxed ${config.info ? 'text-red-800/90' : 'text-blue-800/90'}`}>
            {config.info 
                ? "Alles, was Sie auf dieser Seite tun oder eingeben, wird l√ºckenlos aufgezeichnet. Ihre Informationen werden sofort ausgewertet, um ein pers√∂nliches Bild Ihrer Person und Ihres Privatlebens zu erstellen. Einmal erfasst, bleiben diese Informationen dauerhaft gespeichert."
                : "VitalCore bietet Ihnen eine moderne Plattform f√ºr fundiertes medizinisches Wissen und individuelle Gesundheitsanalysen. Wir laden Sie ein, die verschiedenen Bereiche unseres Portals zu erkunden und unsere Funktionen zu nutzen, um Ihre pers√∂nlichen Ziele f√ºr mehr Wohlbefinden und Vitalit√§t im Alltag zu erreichen."
            }
        </p>
    </div>
</div>

                {/* 2. BANNER-INHALT (Das wei√üe Feld unten) */}
                <div className="flex flex-col lg:flex-row gap-8 items-stretch lg:items-center">
                    <div className="flex-1 space-y-2">
                        <h3 className="text-xl font-black text-slate-900 tracking-tight">Privatsph√§re-Einstellungen</h3>
                        <p className="text-sm text-slate-500 leading-relaxed max-w-2xl">
                            Wir nutzen Cookies und Tracking-Technologien, um Ihr Nutzererlebnis zu personalisieren und unser medizinisches Informationsangebot zu verbessern. 
                            {details && (
                                <span className="block mt-3 p-3 bg-slate-50 rounded-xl border border-slate-100 text-xs text-slate-400 animate-fade-in">
                                    Dabei werden pseudonymisierte Daten an Analyse-Partner √ºbertragen. Dies erm√∂glicht eine algorithmische Anpassung der Inhalte an Ihr Gesundheitsprofil.
                                </span>
                            )}
                        </p>
                        <button onClick={() => setDetails(!details)} className="text-xs text-blue-600 font-bold uppercase tracking-widest hover:text-blue-800 transition-colors">
                            {details ? "‚àí Weniger Informationen" : "+ Mehr Informationen"}
                        </button>
                    </div>

                    {/* Die Buttons */}
                    <div className="flex flex-col gap-3 shrink-0 min-w-[200px] justify-center">
                        <button onClick={() => onDecision('accept_all')} className="px-8 py-4 bg-blue-600 hover:bg-blue-700 text-white font-black rounded-2xl shadow-lg transition-all transform active:scale-95 text-sm uppercase">
                            Alle akzeptieren
                        </button>
                        <button onClick={() => onDecision('reject_all')} className="px-8 py-3 bg-white hover:bg-slate-50 text-slate-400 font-bold border border-slate-200 rounded-2xl transition-colors text-xs uppercase">
                            Nur Notwendige
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
};

       const BlogPage = ({ onAction, mode = 'initial', cookieChoice }) => {
            const [selectedArticle, setSelectedArticle] = useState(null);
            const [categoryFilter, setCategoryFilter] = useState("Alle Beitr√§ge");
            const [showLoginModal, setShowLoginModal] = useState(false);
            const [likes, setLikes] = useState({});
            const [articlesToDisplay, setArticlesToDisplay] = useState([]);

            const requiredTime = mode === 'initial' ? MIN_BROWSING_TIME_1 : MIN_BROWSING_TIME_2;
            const [timeLeft, setTimeLeft] = useState(requiredTime);

            useEffect(() => {
                if (mode === 'initial') {
                    setArticlesToDisplay(BLOG_CONTENT);
                } else {
                    const oldContentShuffled = [...BLOG_CONTENT].sort(() => 0.5 - Math.random());
                    setArticlesToDisplay([...PERSONALIZED_CONTENT, ...oldContentShuffled]);
                }
            }, [mode]);

            useEffect(() => {
                if (timeLeft <= 0) return;
                const timer = setInterval(() => setTimeLeft(prev => prev - 1), 1000);
                return () => clearInterval(timer);
            }, [timeLeft]);

            const filteredArticles = categoryFilter === "Alle Beitr√§ge" 
                ? articlesToDisplay 
                : articlesToDisplay.filter(a => a.cat === categoryFilter);

            const categories = ["Alle Beitr√§ge", "Forschung", "Ern√§hrung", "Fitness", "Mental Health", "Pr√§vention"];
            const toggleLike = (e, id) => { e.stopPropagation(); setLikes(prev => ({...prev, [id]: !prev[id]})); };

            const HeaderTitle = () => (
                <div onClick={() => {setCategoryFilter("Alle Beitr√§ge"); setSelectedArticle(null);}} className="flex items-center gap-2 cursor-pointer hover:opacity-80 transition-opacity">
                    <div className="p-1.5 bg-green-100 rounded text-green-600"><Icon path={paths.leaf} className="w-6 h-6" /></div>
                    <span className="text-xl font-bold tracking-tight text-slate-800">
                        Vital<span className="text-green-600">Core</span>
                        {mode === 'personalized' && <span className="ml-2 text-xs bg-green-600 text-white px-2 py-0.5 rounded uppercase">F√ºr Sie</span>}
                    </span>
                </div>
            );

            const ActionButton = ({inHeader}) => {
                if (mode === 'initial') {
                    if (timeLeft > 0) {
                        return (
                            <button disabled className={`bg-slate-300 text-slate-500 rounded-full font-medium cursor-not-allowed flex items-center gap-2 ${inHeader ? 'px-5 py-2 text-sm' : 'w-full py-3 justify-center'}`}>
                                <Icon path={paths.clock} className="w-4 h-4 animate-pulse" /> Gesundheitsprofil erstellen in {timeLeft}s
                            </button>
                        );
                    }
                    if (cookieChoice === null) {
                        return (
                            <button disabled className={`bg-orange-100 text-orange-600 border border-orange-200 rounded-full font-bold cursor-not-allowed flex items-center gap-2 ${inHeader ? 'px-5 py-2 text-sm' : 'w-full py-3 justify-center'}`}>
                                Bitte treffen Sie eine Cookie-Wahl
                            </button>
                        );
                    }
                    return (
                        <button onClick={onAction} className={`bg-slate-900 text-white rounded-full font-medium hover:bg-slate-800 transition-colors shadow-lg animate-fade-in ${inHeader ? 'px-5 py-2 text-sm' : 'w-full py-3'}`}>
                            Gesundheitsprofil erstellen
                        </button>
                    );
                } else {
                    if (timeLeft > 0) return (<div className={`bg-green-100 text-green-800 rounded-full text-xs font-bold animate-pulse ${inHeader ? 'px-4 py-2' : 'w-full py-3 text-center'}`}>Personalisierte Ansicht aktiv ({timeLeft}s)...</div>);
                    return (
                        <button onClick={onAction} className={`bg-green-600 text-white rounded-full font-bold hover:bg-green-700 transition-colors shadow-lg animate-fade-in ${inHeader ? 'px-6 py-2 text-sm' : 'w-full py-3'}`}>
                            Weiter zum Fragebogen
                        </button>
                    );
                }
            };

            if (selectedArticle) {
                return (
                    <div className="min-h-screen flex flex-col font-sans text-slate-800 bg-white animate-fade-in">
                        <nav className="bg-white border-b sticky top-0 z-20 shadow-sm px-4 h-16 flex items-center justify-between">
                            <HeaderTitle />
                            <div className="flex gap-4 items-center">
                                <button onClick={() => setSelectedArticle(null)} className="text-sm font-medium text-slate-500 hover:text-green-600 flex items-center gap-1">
                                    <Icon path={paths.arrowLeft} className="w-4 h-4" /> Zur√ºck
                                </button>
                                <ActionButton inHeader={true} />
                            </div>
                        </nav>
                        <article className="max-w-3xl mx-auto px-4 py-12">
                            <div className="w-full h-80 rounded-2xl overflow-hidden mb-8 shadow-md">
                                <img src={selectedArticle.image} className="w-full h-full object-cover" />
                            </div>
                            <div className="flex items-center gap-3 text-sm font-bold text-green-600 uppercase tracking-wider mb-3">
                                {selectedArticle.cat} ‚Ä¢ {selectedArticle.date || "Aktuell"}
                            </div>
                            <h1 className="text-4xl font-extrabold text-slate-900 mb-6 leading-tight">{selectedArticle.title}</h1>
                            <div className="flex items-center gap-3 text-slate-500 mb-8 pb-8 border-b">
                                <span className="font-medium">{selectedArticle.author}</span>
                                <span>‚Ä¢</span>
                                <span className="flex items-center gap-1"><Icon path={paths.clock} className="w-4 h-4" /> {selectedArticle.time} Lesezeit</span>
                            </div>
                            <div className="prose prose-lg text-slate-700 leading-relaxed space-y-6">
                                {selectedArticle.fullText.map((p, i) => <p key={i}>{p}</p>)}
                            </div>
                        </article>
                    </div>
                );
            }

            return (
                <div className="min-h-screen flex flex-col font-sans text-slate-800 bg-slate-50 relative">
                    <nav className="bg-white border-b sticky top-0 z-20 shadow-sm">
                        <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
                            <HeaderTitle />
                            <div className="hidden md:flex gap-1 mx-4">
                                {categories.map(item => (
                                    <button key={item} onClick={() => setCategoryFilter(item)} className={`whitespace-nowrap px-3 py-2 text-sm font-medium rounded-full transition-colors ${categoryFilter === item ? 'bg-slate-900 text-white' : 'text-slate-500 hover:bg-slate-100'}`}>
                                        {item}
                                    </button>
                                ))}
                            </div>
                            <div className="flex gap-4 items-center shrink-0">
                                <button className="p-2 text-slate-400 hover:text-slate-600" onClick={() => setShowLoginModal(true)}>
                                    <Icon path={paths.search} className="w-5 h-5" />
                                </button>
                                <ActionButton inHeader={true} />
                            </div>
                        </div>
                    </nav>

                    <main className="flex-grow max-w-6xl mx-auto px-4 py-8 w-full">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {filteredArticles.map(art => (
                                <article key={art.id} onClick={() => setSelectedArticle(art)} className="bg-white rounded-2xl border border-slate-100 shadow-sm hover:shadow-lg transition-all cursor-pointer overflow-hidden group flex flex-col h-full relative">
                                    {art.match && <div className="absolute top-3 left-3 z-10 bg-green-500 text-white text-xs font-bold px-2 py-1 rounded shadow-lg">{art.match}</div>}
                                    <div className="h-48 overflow-hidden relative">
                                        <img src={art.image} className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" />
                                        <div className="absolute top-3 right-3">
                                            <button onClick={(e) => toggleLike(e, art.id)} className={`p-2 rounded-full backdrop-blur-md transition-colors ${likes[art.id] ? 'bg-red-50 text-red-500' : 'bg-black/30 text-white'}`}>
                                                <Icon path={likes[art.id] ? paths.heartFilled : paths.heart} className="w-5 h-5" />
                                            </button>
                                        </div>
                                    </div>
                                    <div className="p-5 flex-1 flex flex-col">
                                        <div className="text-[10px] font-black text-green-600 uppercase tracking-widest mb-2">{art.cat}</div>
                                        <h3 className="text-lg font-bold text-slate-900 mb-2 group-hover:text-green-600 transition-colors leading-tight">{art.title}</h3>
                                        <p className="text-slate-600 text-sm line-clamp-3 mb-4 flex-1">{art.desc}</p>
                                        <div className="flex items-center justify-between pt-4 border-t border-slate-100">
                                            <span className="text-xs font-bold text-slate-500 uppercase">{art.author}</span>
                                            <span className="text-[10px] text-slate-400">{art.time}</span>
                                        </div>
                                    </div>
                                </article>
                            ))}
                        </div>
                    </main>

                    {showLoginModal && (
                        <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4" onClick={() => setShowLoginModal(false)}>
                            <div className="bg-white rounded-xl p-8 max-w-sm w-full text-center" onClick={(e) => e.stopPropagation()}>
                                <div className="w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <Icon path={paths.shield} className="w-6 h-6" />
                                </div>
                                <h3 className="text-xl font-bold mb-2">Zugriff verweigert</h3>
                                <p className="text-gray-600 mb-6">Dieser Bereich ist f√ºr Teilnehmer der Studie reserviert.</p>
                                <button onClick={() => setShowLoginModal(false)} className="w-full bg-gray-900 text-white font-bold py-2 rounded-lg">Verstanden</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 1. HELFER-KOMPONENTEN (JETZT AUSSERHALB - BEHEBT DEN CURSOR-FEHLER)
const NoAnswer = ({ field, noAnswers, setNoAnswers }) => (
    <label className="flex items-center gap-2 mt-2 cursor-pointer w-fit group">
        <input 
            type="checkbox" 
            checked={!!noAnswers[field]} 
            onChange={() => setNoAnswers(prev => ({ ...prev, [field]: !prev[field] }))} 
            className="w-3.5 h-3.5 rounded border-slate-300 text-blue-600 focus:ring-blue-500" 
        />
        <span className="text-[9px] text-slate-400 group-hover:text-slate-600 uppercase tracking-widest font-bold transition-colors">Keine Angabe</span>
    </label>
);

const JaNeinInput = ({ label, field, placeholder, formData, setFormData, noAnswers, setNoAnswers, interact }) => {
    const handleTextChange = (e) => {
        interact();
        setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
    };

    return (
        <div className={noAnswers[field] ? 'opacity-30' : ''}>
            <label className="text-sm font-bold text-slate-700 block mb-3">{label}</label>
            <div className="flex gap-4 mb-3">
                {['ja', 'nein'].map(opt => (
                    <button 
                        key={opt} 
                        type="button" 
                        disabled={noAnswers[field]} 
                        onClick={() => { interact(); setFormData(prev => ({...prev, [field]: opt})); }} 
                        className={`px-6 py-2 rounded-full text-xs font-black border-2 transition-all ${formData[field] === opt ? 'bg-slate-900 border-slate-900 text-white' : 'bg-transparent border-slate-200 text-slate-400'}`}
                    >
                        {opt.toUpperCase()}
                    </button>
                ))}
            </div>
            {formData[field] === 'ja' && !noAnswers[field] && (
                <textarea 
                    name={`${field}Details`} 
                    value={formData[`${field}Details`] || ''} 
                    onChange={handleTextChange} 
                    placeholder={placeholder} 
                    className="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl text-xs outline-none focus:bg-white h-20 animate-fade-in" 
                />
            )}
            <NoAnswer field={field} noAnswers={noAnswers} setNoAnswers={setNoAnswers} />
        </div>
    );
};

// 2. DIE VOLLST√ÑNDIGE REGISTRATION FORM
const RegistrationForm = ({ onSubmit, group, audioObject }) => {
    const [formData, setFormData] = useState({ 
        age: '', gender: '', height: '', weight: '', insurance: '',
        dietStyle: [], dietHistory: '', tobacco: '', tobaccoDetails: '',
        alcohol: '', alcoholDetails: '', drugs: '', drugsDetails: '',
        sportFreq: '', sportType: '', bodySatisfaction: 5, 
        bodyChangeGoals: '', bodyChangeDetails: '',
        mentalHealth: '', mentalHealthDetails: '',
        sexOrientation: '', reproduction: '', stis: '', stisDetails: '',
        income: '', debts: '', debtsDetails: ''
    });

    const [noAnswers, setNoAnswers] = useState({});
    const [interactionStarted, setInteractionStarted] = useState(false);
    const [timeLeft, setTimeLeft] = useState(MIN_REGISTRATION_TIME);
    
    useEffect(() => { 
        const timer = setInterval(() => setTimeLeft(t => t > 0 ? t - 1 : 0), 1000); 
        return () => clearInterval(timer); 
    }, []);

    const config = getGroupConfig(group);
    const interact = () => { 
        if (!interactionStarted) { 
            setInteractionStarted(true); 
            if (config.sound && audioObject) audioObject.play().catch(()=>{}); 
        } 
    };

    const handleChange = (e) => { 
        interact(); 
        const { name, value } = e.target;
        const val = (name === 'age' || name === 'height' || name === 'weight') ? value.replace(/[^0-9]/g, '') : value;
        setFormData(prev => ({...prev, [name]: val}));
    };

    const isFormComplete = () => {
        const check = (f) => noAnswers[f] || (formData[f] !== '' && formData[f] !== undefined && (Array.isArray(formData[f]) ? formData[f].length > 0 : true));
        const required = ['age', 'gender', 'height', 'weight', 'insurance', 'dietStyle', 'dietHistory', 'sportFreq', 'tobacco', 'alcohol', 'drugs', 'bodySatisfaction', 'bodyChangeGoals', 'mentalHealth', 'sexOrientation', 'reproduction', 'stis', 'income', 'debts'];
        return required.every(f => check(f));
    };

    return (
    <div className="min-h-screen bg-slate-100 py-12 px-4 relative pt-40 text-slate-900">
        {/* Augen und Box erscheinen erst, wenn interactionStarted auf true springt */}
        {interactionStarted && (
            <React.Fragment>
                <StimulusOverlay config={config} variant="form" />
                
                <div className="fixed top-[155px] left-1/2 -translate-x-1/2 w-[95%] max-w-xl z-[50] animate-fade-in pointer-events-none">
                    <div className={`backdrop-blur-sm border-2 p-4 rounded-[24px] shadow-xl shadow-black/5 ${config.info ? 'bg-red-50/95 border-red-200' : 'bg-blue-50/95 border-blue-200'}`}>
                        <div className={`flex items-center gap-2 font-black mb-1 uppercase tracking-tighter text-[10px] ${config.info ? 'text-red-600' : 'text-blue-600'}`}>
                            <Icon path={config.info ? paths.shield : paths.activity} className="w-4 h-4"/> 
                            {config.info ? 'HINWEIS ZUR DATENERFASSUNG' : 'WILLKOMMEN BEI VITALCORE'}
                        </div>
                        <p className={`text-[9px] leading-relaxed ${config.info ? 'text-red-800/90' : 'text-blue-800/90'}`}>
                            {config.info 
                                ? "Alles, was Sie auf dieser Seite tun oder eingeben, wird l√ºckenlos aufgezeichnet. Ihre Informationen werden sofort ausgewertet, um ein pers√∂nliches Bild Ihrer Person und Ihres Privatlebens zu erstellen. Einmal erfasst, bleiben diese Informationen dauerhaft gespeichert."
                                : "VitalCore bietet Ihnen eine moderne Plattform f√ºr fundiertes medizinisches Wissen und individuelle Gesundheitsanalysen. Wir laden Sie ein, die verschiedenen Bereiche unseres Portals zu erkunden und unsere Funktionen zu nutzen, um Ihre pers√∂nlichen Ziele f√ºr mehr Wohlbefinden und Vitalit√§t im Alltag zu erreichen."
                            }
                        </p>
                    </div>
                </div>
            </React.Fragment>
        )}
            
            <div className="max-w-2xl mx-auto bg-white shadow-2xl rounded-[40px] overflow-hidden border border-slate-200 relative z-10">
                <header className="bg-slate-900 p-10 text-white text-center">
                    <h2 className="text-lg font-light tracking-[0.2em] uppercase">Systembiologisches Gesundheitsprofil</h2>
                    <span className="text-[10px] text-blue-400 font-bold uppercase mt-2 block">Clinical Data Access</span>
                </header>

                <form onSubmit={(e) => {e.preventDefault(); if(isFormComplete()) onSubmit(formData);}} className="p-8 md:p-12 space-y-16">
                    
                    <section className="space-y-8">
                        <h3 className="text-[11px] font-black uppercase tracking-widest text-blue-600 mb-6 border-b pb-2">Modul 01: Biometrische Parameter</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div className={noAnswers.age ? 'opacity-30' : ''}>
                                <label className="text-sm font-bold block mb-2">Wie alt sind Sie?</label>
                                <input type="text" name="age" disabled={noAnswers.age} value={formData.age} onChange={handleChange} className="w-full py-2 border-b border-slate-200 outline-none bg-transparent" />
                                <NoAnswer field="age" noAnswers={noAnswers} setNoAnswers={setNoAnswers} />
                            </div>
                            <div className={noAnswers.gender ? 'opacity-30' : ''}>
                                <label className="text-sm font-bold block mb-2">Welchem Geschlecht f√ºhlen Sie sich zugeh√∂rig?</label>
                                <select name="gender" disabled={noAnswers.gender} value={formData.gender} onChange={handleChange} className="w-full py-2 border-b border-slate-200 outline-none bg-transparent text-sm">
                                    <option value="">W√§hlen...</option><option value="m">M√§nnlich</option><option value="w">Weiblich</option><option value="d">Divers</option>
                                </select>
                                <NoAnswer field="gender" noAnswers={noAnswers} setNoAnswers={setNoAnswers} />
                            </div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div className={noAnswers.height ? 'opacity-30' : ''}>
                                <label className="text-sm font-bold block mb-2">Ihre K√∂rpergr√∂√üe (cm)?</label>
                                <input type="text" name="height" disabled={noAnswers.height} value={formData.height} onChange={handleChange} className="w-full py-2 border-b border-slate-200 outline-none bg-transparent" />
                                <NoAnswer field="height" noAnswers={noAnswers} setNoAnswers={setNoAnswers} />
                            </div>
                            <div className={noAnswers.weight ? 'opacity-30' : ''}>
                                <label className="text-sm font-bold block mb-2">Ihr K√∂rpergewicht (kg)?</label>
                                <input type="text" name="weight" disabled={noAnswers.weight} value={formData.weight} onChange={handleChange} className="w-full py-2 border-b border-slate-200 outline-none bg-transparent" />
                                <NoAnswer field="weight" noAnswers={noAnswers} setNoAnswers={setNoAnswers} />
                            </div>
                        </div>
                        <div className={noAnswers.insurance ? 'opacity-30' : ''}>
                            <label className="text-sm font-bold block mb-2">Wie sind Sie versichert?</label>
                            <select name="insurance" disabled={noAnswers.insurance} value={formData.insurance} onChange={handleChange} className="w-full py-2 border-b border-slate-200 outline-none bg-transparent text-sm">
                                <option value="">W√§hlen...</option><option value="gkv">Gesetzlich</option><option value="pkv">Privat</option><option value="andere">Andere</option>
                            </select>
                            <NoAnswer field="insurance" noAnswers={noAnswers} setNoAnswers={setNoAnswers} />
                        </div>
                    </section>

                    <section className="space-y-8">
                        <h3 className="text-[11px] font-black uppercase tracking-widest text-blue-600 mb-6 border-b pb-2">Modul 02: Metabolischer Lebensstil</h3>
                        <div className={noAnswers.dietStyle ? 'opacity-30' : ''}>
                            <label className="text-sm font-bold block mb-4">Welche Ern√§hrungsform(en) praktizieren Sie aktuell?</label>
                            <div className="flex flex-wrap gap-2">
                                {['Omnivor', 'Vegetarisch', 'Vegan', 'Keto', 'Fasten', 'Intervall'].map(diet => (
                                    <button key={diet} type="button" disabled={noAnswers.dietStyle} onClick={() => { interact(); const next = formData.dietStyle.includes(diet) ? formData.dietStyle.filter(d => d !== diet) : [...formData.dietStyle, diet]; setFormData(prev => ({...prev, dietStyle: next})); }} className={`px-4 py-2 rounded-full text-xs font-bold border-2 transition-all ${formData.dietStyle.includes(diet) ? 'bg-blue-600 border-blue-600 text-white shadow-md' : 'border-slate-200 text-slate-400'}`}>
                                        {diet}
                                    </button>
                                ))}
                            </div>
                            <NoAnswer field="dietStyle" noAnswers={noAnswers} setNoAnswers={setNoAnswers} />
                        </div>
                        <div className={noAnswers.dietHistory ? 'opacity-30' : ''}>
                             <label className="text-sm font-bold block mb-2">Haben Sie in der Vergangenheit Di√§ten zur Gewichtsreduktion durchgef√ºhrt?</label>
                             <textarea name="dietHistory" disabled={noAnswers.dietHistory} value={formData.dietHistory} onChange={handleChange} placeholder="" className="w-full p-4 bg-slate-50 border border-slate-100 rounded-lg outline-none h-20" />
                             <NoAnswer field="dietHistory" noAnswers={noAnswers} setNoAnswers={setNoAnswers} />
                        </div>
                    </section>

                    <section className="space-y-12">
                        <h3 className="text-[11px] font-black uppercase tracking-widest text-blue-600 mb-6 border-b pb-2">Modul 03-04: Lebensstil & Toxikologie</h3>
                        <div className={noAnswers.sportFreq ? 'opacity-30' : ''}>
                            <label className="text-sm font-bold block mb-2">Wie h√§ufig treiben Sie Sport?</label>
                            <select name="sportFreq" disabled={noAnswers.sportFreq} value={formData.sportFreq} onChange={handleChange} className="w-full py-2 border-b border-slate-200 outline-none bg-transparent text-sm">
                                <option value="">W√§hlen...</option><option value="t√§glich">T√§glich</option><option value="oft">2-4 mal pro Woche</option><option value="selten">1 mal pro Woche</option><option value="nie">Seltener / Nie</option>
                            </select>
                            {formData.sportFreq !== 'nie' && formData.sportFreq !== '' && !noAnswers.sportFreq && (
                                <div className="mt-4 animate-fade-in">
                                    <label className="text-[10px] font-bold text-slate-400 uppercase block mb-2">Welche Sportarten √ºben Sie aus?</label>
                                    <input type="text" name="sportType" value={formData.sportType} onChange={handleChange} placeholder="" className="w-full py-2 border-b border-slate-200 outline-none bg-transparent text-sm" />
                                </div>
                            )}
                            <NoAnswer field="sportFreq" noAnswers={noAnswers} setNoAnswers={setNoAnswers} />
                        </div>
                        <JaNeinInput label="Konsumieren Sie Tabak- oder Nikotinprodukte?" field="tobacco" placeholder="Welche Produkte und wie h√§ufig?" formData={formData} setFormData={setFormData} noAnswers={noAnswers} setNoAnswers={setNoAnswers} interact={interact} />
                        <JaNeinInput label="Konsumieren Sie regelm√§√üig alkoholische Getr√§nke?" field="alcohol" placeholder="Welche Getr√§nke und wie h√§ufig?" formData={formData} setFormData={setFormData} noAnswers={noAnswers} setNoAnswers={setNoAnswers} interact={interact} />
                        <JaNeinInput label="Nutzen Sie illegale Substanzen (z.B. Cannabis, Kokain)?" field="drugs" placeholder="Welche Substanzen und wie h√§ufig?" formData={formData} setFormData={setFormData} noAnswers={noAnswers} setNoAnswers={setNoAnswers} interact={interact} />
                    </section>

                    <section className="space-y-12">
    <h3 className="text-[11px] font-black uppercase tracking-widest text-blue-600 mb-6 border-b pb-2">
        Modul 05: Psychosomatische Selbstwahrnehmung
    </h3>
    
    <div className={noAnswers.bodySatisfaction ? 'opacity-30' : ''}>
        <label className="text-sm font-bold block mb-1">
            Wie zufrieden sind Sie mit Ihrem aktuellen K√∂rperzustand (1-10)?
        </label>
        
        {/* Der Slider */}
        <input 
            type="range" 
            name="bodySatisfaction" 
            min="1" 
            max="10" 
            disabled={noAnswers.bodySatisfaction} 
            value={formData.bodySatisfaction} 
            onChange={handleChange} 
            className="w-full accent-blue-600 cursor-pointer" 
        />
        
        {/* Die Zahlenskala von 1 bis 10 */}
        <div className="flex justify-between px-1 mt-2 text-[10px] text-slate-400 font-bold select-none">
            {[...Array(10)].map((_, i) => {
                const val = i + 1;
                const isActive = formData.bodySatisfaction == val && !noAnswers.bodySatisfaction;
                return (
                    <span 
                        key={val} 
                        className={`transition-all duration-200 ${isActive ? 'text-blue-600 scale-150' : ''}`}
                    >
                        {val}
                    </span>
                );
            })}
        </div>
        
        <NoAnswer field="bodySatisfaction" noAnswers={noAnswers} setNoAnswers={setNoAnswers} />
    </div>

    <JaNeinInput 
        label="Gibt es spezifische Aspekte an Ihrem K√∂rper, die Sie operativ √§ndern m√∂chten?" 
        field="bodyChangeGoals" 
        placeholder="Welche Eingriffe ziehen Sie in Erw√§gung?" 
        formData={formData} 
        setFormData={setFormData} 
        noAnswers={noAnswers} 
        setNoAnswers={setNoAnswers} 
        interact={interact} 
    />
    
    <JaNeinInput 
        label="Bestehen psychische Vorbelastungen oder befinden Sie sich in Behandlung?" 
        field="mentalHealth" 
        placeholder="Diagnosen oder Behandlungen?" 
        formData={formData} 
        setFormData={setFormData} 
        noAnswers={noAnswers} 
        setNoAnswers={setNoAnswers} 
        interact={interact} 
    />
</section>

                    <section className="space-y-12">
                        <h3 className="text-[11px] font-black uppercase tracking-widest text-blue-600 mb-6 border-b pb-2">Modul 06: Reproduktive Analyse</h3>
                        <div className={noAnswers.sexOrientation ? 'opacity-30' : ''}>
                            <label className="text-sm font-bold block mb-2">Was ist Ihre sexuelle Orientierung?</label>
                            <select name="sexOrientation" disabled={noAnswers.sexOrientation} value={formData.sexOrientation} onChange={handleChange} className="w-full py-2 border-b border-slate-200 outline-none bg-transparent text-sm">
                                <option value="">W√§hlen...</option><option value="hetero">Heterosexuell</option><option value="homo">Homosexuell</option><option value="bi">Bisexuell</option><option value="andere">Andere</option>
                            </select>
                            <NoAnswer field="sexOrientation" noAnswers={noAnswers} setNoAnswers={setNoAnswers} />
                        </div>
                        <div className={noAnswers.reproduction ? 'opacity-30' : ''}>
                            <label className="text-sm font-bold block mb-2">Besteht bei Ihnen aktuell ein Reproduktionswunsch (Kinderwunsch)?</label>
                            <select name="reproduction" disabled={noAnswers.reproduction} value={formData.reproduction} onChange={handleChange} className="w-full py-2 border-b border-slate-200 outline-none bg-transparent text-sm">
                                <option value="">W√§hlen...</option><option value="ja">Ja</option><option value="nein">Nein</option><option value="vielleicht">Vielleicht</option>
                            </select>
                            <NoAnswer field="reproduction" noAnswers={noAnswers} setNoAnswers={setNoAnswers} />
                        </div>
                        <JaNeinInput label="Sind Ihnen aktuelle oder vergangene Geschlechtskrankheiten bekannt?" field="stis" placeholder="Historie der Infektionen..." formData={formData} setFormData={setFormData} noAnswers={noAnswers} setNoAnswers={setNoAnswers} interact={interact} />
                    </section>

                    <section className="space-y-12">
                        <h3 className="text-[11px] font-black uppercase tracking-widest text-blue-600 mb-6 border-b pb-2">Modul 07: Sozio-√ñkonomischer Status</h3>
                        <div className={noAnswers.income ? 'opacity-30' : ''}>
                            <label className="text-sm font-bold block mb-2">Wie hoch ist ihr monatliches Netto-Einkommen?</label>
                            <select name="income" disabled={noAnswers.income} value={formData.income} onChange={handleChange} className="w-full py-2 border-b border-slate-200 outline-none bg-transparent text-sm">
                                <option value="">W√§hlen...</option><option value="1">Bis 1.500 ‚Ç¨</option><option value="2">1.500 ‚Ç¨ - 3.500 ‚Ç¨</option><option value="3">3.500 ‚Ç¨ - 5.000 ‚Ç¨</option><option value="4">√úber 5.000 ‚Ç¨</option>
                            </select>
                            <NoAnswer field="income" noAnswers={noAnswers} setNoAnswers={setNoAnswers} />
                        </div>
                        <JaNeinInput label="Bestehen finanzielle Schulden?" field="debts" placeholder="Art oder ungef√§hre H√∂he der Schulden?" formData={formData} setFormData={setFormData} noAnswers={noAnswers} setNoAnswers={setNoAnswers} interact={interact} />
                    </section>

                    <button type="submit" disabled={timeLeft > 0 || !isFormComplete()} className={`w-full py-6 font-black text-xs uppercase tracking-[0.5em] rounded-3xl transition-all ${timeLeft > 0 || !isFormComplete() ? 'bg-slate-100 text-slate-300 cursor-not-allowed shadow-none' : 'bg-blue-600 text-white hover:bg-blue-700 shadow-2xl active:scale-[0.98]'}`}>
                        {!isFormComplete() ? 'DATENSATZ UNVOLLST√ÑNDIG' : (timeLeft > 0 ? `VALIDIERUNG L√ÑUFT (${timeLeft}S)` : 'GESUNDHEITSPROFIL FINALISIEREN')}
                    </button>
                </form>
            </div>
        </div>
    );
};

        const LoadingScreen = ({ onFinished }) => {
            useEffect(() => { const timer = setTimeout(onFinished, 3000); return () => clearTimeout(timer); }, []);
            return (<div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-4 text-white"><div className="w-20 h-20 border-4 border-blue-500 border-t-transparent rounded-full animate-spin-slow mb-8"></div><h2 className="text-2xl font-bold mb-2">Algorithmus analysiert Profil...</h2><p className="text-slate-400">Suche passende Inhalte f√ºr Sie.</p></div>);
        };

        const EndScreen = ({ data, sessionToken }) => {
            const [targetUrl, setTargetUrl] = useState("");
            const fullDataString = JSON.stringify(data);
            useEffect(() => { 
                const currentGroup = data.groupID; 
                if (sessionToken && currentGroup) { 
                    const finalUrl = SOSCI_BASE_URL + "?i=" + sessionToken + "&IV02_01=" + currentGroup + "&g=" + currentGroup + "&mydata=" + encodeURIComponent(fullDataString);
                    setTargetUrl(finalUrl); 
                } 
            }, [sessionToken, fullDataString, data.groupID]);

            return (
                <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-4 text-center">
                    <div className="bg-white p-10 md:p-16 rounded-[40px] shadow-2xl max-w-lg w-full border-t-[12px] border-green-500 animate-fade-in text-slate-800">
                        <h2 className="text-2xl md:text-3xl font-black mb-6 leading-tight">Danke f√ºrs Ausprobieren unserer Webseite!</h2>
                        <p className="text-lg text-slate-600 mb-10 leading-relaxed">Bitte beantworten Sie nun noch ein paar abschlie√üende Fragen. Klicken Sie dazu bitte auf diesen Button, um zur√ºck zum Fragebogen zu kommen:</p>
                        {targetUrl ? <a href={targetUrl} className="block w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-5 rounded-2xl shadow-xl transition-all transform active:scale-95 no-underline text-xl">Zur√ºck zum Fragebogen</a> : <div className="p-4 bg-red-50 text-red-600 rounded-xl">Fehler: Sitzungstoken nicht gefunden.</div>}
                    </div>
                </div>
            );
        };

        function App() {
            const [step, setStep] = useState('intro');
            const [cookieChoice, setCookieChoice] = useState(null);
            const [bannerVisible, setBannerVisible] = useState(false);
            const [groupID, setGroupID] = useState(0);
            const [finalData, setFinalData] = useState({});
            const [sessionToken, setSessionToken] = useState(null);
            const timers = useRef({ blogStart: 0, bannerStart: 0, formStart: 0, postBrowsingStart: 0 });
            const [times, setTimes] = useState({ blogTime: 0, cookieTime: 0, registrationTime: 0, postBrowsingTime: 0 });
            const audioRef = useRef(null);
            const audioManRef = useRef(null);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const g = parseInt(params.get('g')) || 0;
                setGroupID(g);
                const t = params.get('t');
                if (t) setSessionToken(t);
                audioRef.current = new Audio('sound.mp3'); audioRef.current.volume = 0.5;
                audioManRef.current = new Audio('soundmann.mp3'); audioManRef.current.volume = 0.5;
            }, []);

            const handleStartStudy = () => {
                const unlockAudio = (audioObj) => { if (audioObj) { audioObj.volume = 0; audioObj.play().then(() => { audioObj.pause(); audioObj.currentTime = 0; audioObj.volume = 0.5; }).catch(e => console.log("Unlock failed", e)); } };
                unlockAudio(audioRef.current); unlockAudio(audioManRef.current);
                timers.current.blogStart = Date.now(); setStep('blog'); setTimeout(() => setBannerVisible(true), COOKIE_BANNER_DELAY_MS);
            };

            const handleBannerLoad = () => { timers.current.bannerStart = Date.now(); };
            const handleCookieDecision = (decision) => { const duration = Date.now() - timers.current.bannerStart; setTimes(prev => ({ ...prev, cookieTime: duration })); setCookieChoice(decision); setBannerVisible(false); };
            const handleGoToRegistration = () => { const duration = Date.now() - timers.current.blogStart; setTimes(prev => ({ ...prev, blogTime: duration })); timers.current.formStart = Date.now(); setStep('register'); };
            const handleRegistrationSubmit = (formData) => { const duration = Date.now() - timers.current.formStart; setTimes(prev => ({ ...prev, registrationTime: duration })); setFinalData(prev => ({ ...prev, groupID: groupID, ...formData, cookieChoice: cookieChoice })); setStep('loading'); };
            const handleLoadingFinished = () => { timers.current.postBrowsingStart = Date.now(); setStep('personalized_blog'); };
            const handleFinishStudy = () => { const duration = Date.now() - timers.current.postBrowsingStart; const completeData = { ...finalData, ...times, postBrowsingTime: duration }; setFinalData(completeData); setStep('end'); };

            return (
    <div className="font-sans text-gray-800 antialiased selection:bg-blue-100 selection:text-blue-900">
        {/* 1. Intro */}
        {step === 'intro' && <IntroScreen onStart={() => setStep('audio_test')} />}

        {/* 2. NEU: Audio Test */}
        {step === 'audio_test' && (
            <AudioTest 
                audioFile="Glocke.mp3" 
                onPassed={() => {
                    // Wenn bestanden, starte Timer und zeige Blog
                    timers.current.blogStart = Date.now();
                    setStep('blog');
                    setTimeout(() => setBannerVisible(true), COOKIE_BANNER_DELAY_MS);
                }} 
            />
        )}

        {/* 3. Blog & Cookie Banner */}
        {step === 'blog' && (
            <>
                <BlogPage onAction={handleGoToRegistration} mode="initial" cookieChoice={cookieChoice} />
                {bannerVisible && (
                    <CookieBanner 
                        group={groupID} 
                        onDecision={handleCookieDecision} 
                        audioObject={audioRef.current} 
                        onBannerLoad={handleBannerLoad} 
                    />
                )}
            </>
        )}

        {/* 4. Registrierung */}
        {step === 'register' && <RegistrationForm onSubmit={handleRegistrationSubmit} group={groupID} audioObject={audioManRef.current} />}
        
        {/* 5. Loading */}
        {step === 'loading' && <LoadingScreen onFinished={handleLoadingFinished} />}
        
        {/* 6. Personalisierter Blog */}
        {step === 'personalized_blog' && <BlogPage onAction={handleFinishStudy} mode="personalized" cookieChoice={cookieChoice} />}
        
        {/* 7. Ende */}
        {step === 'end' && <EndScreen data={finalData} sessionToken={sessionToken} />}
    </div>
);
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
